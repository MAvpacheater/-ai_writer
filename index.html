<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–Ü-–ü–∏—Å—å–º–µ–Ω–Ω–∏–∫</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; }
        .tab-active { background: #f59e0b; color: #000; }
        .tab-inactive { background: #334155; }
        .tab-inactive:hover { background: #475569; }
    </style>
</head>
<body class="text-white">
    <div class="max-w-6xl mx-auto p-4">
        <div class="flex items-center gap-3 mb-8">
            <svg class="w-10 h-10 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
            </svg>
            <h1 class="text-4xl font-bold">–®–Ü-–ü–∏—Å—å–º–µ–Ω–Ω–∏–∫</h1>
        </div>

        <!-- –ù–∞–≤—ñ–≥–∞—Ü—ñ—è -->
        <div class="flex gap-2 mb-6 flex-wrap">
            <button onclick="switchTab('setup')" id="tab-setup" class="tab-active px-6 py-2 rounded-lg font-semibold">1. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
            <button onclick="switchTab('outline')" id="tab-outline" class="tab-inactive px-6 py-2 rounded-lg font-semibold">2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞</button>
            <button onclick="switchTab('generate')" id="tab-generate" class="tab-inactive px-6 py-2 rounded-lg font-semibold">3. –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è</button>
            <button onclick="switchTab('export')" id="tab-export" class="tab-inactive px-6 py-2 rounded-lg font-semibold">4. –ï–∫—Å–ø–æ—Ä—Ç</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è -->
        <div id="content-setup" class="tab-content">
            <div class="bg-slate-800 p-6 rounded-lg mb-6">
                <h2 class="text-2xl font-bold mb-4">API –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
                
                <label class="block mb-2 text-sm">Gemini API Key:</label>
                <input type="password" id="apiKey" class="w-full bg-slate-700 p-3 rounded mb-4" placeholder="AIza...">
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block mb-2 text-sm">Temperature: <span id="tempValue">0.9</span></label>
                        <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.9" class="w-full">
                    </div>
                    <div>
                        <label class="block mb-2 text-sm">–ü–æ–µ—Ç–∏—á–Ω—ñ—Å—Ç—å: <span id="poetryValue">7</span>/10</label>
                        <input type="range" id="poetryLevel" min="1" max="10" value="7" class="w-full">
                    </div>
                </div>
            </div>

            <div class="bg-slate-800 p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-4">–ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –∫–Ω–∏–≥–∏</h2>
                
                <input id="title" placeholder="–ù–∞–∑–≤–∞ –∫–Ω–∏–≥–∏" class="w-full bg-slate-700 p-3 rounded mb-3">
                
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <input id="genre" placeholder="–ñ–∞–Ω—Ä" class="bg-slate-700 p-3 rounded">
                    <input id="style" placeholder="–°—Ç–∏–ª—å" class="bg-slate-700 p-3 rounded">
                </div>
                
                <textarea id="characters" placeholder="–ü–µ—Ä—Å–æ–Ω–∞–∂—ñ (–æ–ø–∏—Å, —Ö–∞—Ä–∞–∫—Ç–µ—Ä, –º–æ—Ç–∏–≤–∞—Ü—ñ—è)" class="w-full bg-slate-700 p-3 rounded mb-3 h-24"></textarea>
                <textarea id="world" placeholder="–°–≤—ñ—Ç/—Å–µ—Ç—Ç—ñ–Ω–≥" class="w-full bg-slate-700 p-3 rounded mb-3 h-24"></textarea>
                <textarea id="mainIdea" placeholder="–ì–æ–ª–æ–≤–Ω–∞ —ñ–¥–µ—è –∫–Ω–∏–≥–∏" class="w-full bg-slate-700 p-3 rounded mb-3 h-24"></textarea>
                <textarea id="conflict" placeholder="–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π –∫–æ–Ω—Ñ–ª—ñ–∫—Ç" class="w-full bg-slate-700 p-3 rounded mb-3 h-24"></textarea>
                
                <div class="mb-4">
                    <label class="block mb-2">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–æ–∑–¥—ñ–ª—ñ–≤: <span id="chaptersValue">10</span></label>
                    <input type="range" id="chaptersCount" min="3" max="50" value="10" class="w-full">
                </div>
                
                <button onclick="saveSettings()" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg">
                    üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                </button>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ -->
        <div id="content-outline" class="tab-content hidden">
            <div class="bg-slate-800 p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-4">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–Ω–∏–≥–∏</h2>
                <button onclick="generateOutline()" id="btnOutline" class="bg-amber-500 hover:bg-amber-600 text-black px-6 py-3 rounded-lg mb-4">
                    ‚ñ∂Ô∏è –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ outline
                </button>
                <div id="outlineContent" class="space-y-4"></div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è -->
        <div id="content-generate" class="tab-content hidden">
            <div class="bg-slate-800 p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-4">–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ä–æ–∑–¥—ñ–ª—ñ–≤</h2>
                <div id="generateContent"></div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞: –ï–∫—Å–ø–æ—Ä—Ç -->
        <div id="content-export" class="tab-content hidden">
            <div class="bg-slate-800 p-6 rounded-lg">
                <h2 class="text-2xl font-bold mb-4">üì• –ï–∫—Å–ø–æ—Ä—Ç –∫–Ω–∏–≥–∏</h2>
                <p class="mb-4 text-slate-300">–ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ —Ä–æ–∑–¥—ñ–ª—ñ–≤: <span id="exportStatus">0 / 0</span></p>
                
                <div class="flex gap-4 flex-wrap mb-8">
                    <button onclick="exportBook('txt')" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg">üìÑ TXT</button>
                    <button onclick="exportBook('html')" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg">üåê HTML</button>
                    <button onclick="exportBook('epub')" class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg">üìö EPUB</button>
                </div>
                
                <h3 class="text-xl font-bold mb-4">–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥:</h3>
                <div id="previewContent" class="bg-slate-900 p-6 rounded max-h-96 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <script>
        // –ú–æ–¥—É–ª—å: Storage Manager
        const Storage = {
            save: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
            load: (key) => {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            }
        };

        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
        let outline = null;
        let chapters = [];
        let context = {};

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        window.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            updateSliders();
        });

        function updateSliders() {
            document.getElementById('temperature').addEventListener('input', e => {
                document.getElementById('tempValue').textContent = e.target.value;
            });
            document.getElementById('poetryLevel').addEventListener('input', e => {
                document.getElementById('poetryValue').textContent = e.target.value;
            });
            document.getElementById('chaptersCount').addEventListener('input', e => {
                document.getElementById('chaptersValue').textContent = e.target.value;
            });
        }

        function loadSettings() {
            const saved = Storage.load('settings');
            if (saved) {
                document.getElementById('apiKey').value = saved.apiKey || '';
                document.getElementById('temperature').value = saved.temperature || 0.9;
                document.getElementById('poetryLevel').value = saved.poetryLevel || 7;
                document.getElementById('title').value = saved.title || '';
                document.getElementById('genre').value = saved.genre || '';
                document.getElementById('style').value = saved.style || '';
                document.getElementById('characters').value = saved.characters || '';
                document.getElementById('world').value = saved.world || '';
                document.getElementById('mainIdea').value = saved.mainIdea || '';
                document.getElementById('conflict').value = saved.conflict || '';
                document.getElementById('chaptersCount').value = saved.chapters || 10;
                updateSliders();
            }
            
            const savedBook = Storage.load('currentBook');
            if (savedBook) {
                outline = savedBook.outline;
                chapters = savedBook.chapters || [];
            }
        }

        function saveSettings() {
            const settings = {
                apiKey: document.getElementById('apiKey').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                poetryLevel: parseInt(document.getElementById('poetryLevel').value),
                title: document.getElementById('title').value,
                genre: document.getElementById('genre').value,
                style: document.getElementById('style').value,
                characters: document.getElementById('characters').value,
                world: document.getElementById('world').value,
                mainIdea: document.getElementById('mainIdea').value,
                conflict: document.getElementById('conflict').value,
                chapters: parseInt(document.getElementById('chaptersCount').value)
            };
            
            Storage.save('settings', settings);
            Storage.save('currentBook', { outline, chapters });
            alert('‚úÖ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ!');
        }

        // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tab) {
            ['setup', 'outline', 'generate', 'export'].forEach(t => {
                document.getElementById('content-' + t).classList.add('hidden');
                document.getElementById('tab-' + t).className = 'tab-inactive px-6 py-2 rounded-lg font-semibold';
            });
            
            document.getElementById('content-' + tab).classList.remove('hidden');
            document.getElementById('tab-' + tab).className = 'tab-active px-6 py-2 rounded-lg font-semibold';
        }

        // API –≤–∏–∫–ª–∏–∫
        async function callAPI(prompt) {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                alert('‚ö†Ô∏è –í–≤–µ–¥—ñ—Ç—å API –∫–ª—é—á!');
                throw new Error('No API key');
            }

            const settings = {
                temperature: parseFloat(document.getElementById('temperature').value),
                poetryLevel: parseInt(document.getElementById('poetryLevel').value)
            };

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        temperature: settings.temperature,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 8000
                    }
                })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error?.message || 'API error');
            return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è outline
        async function generateOutline() {
            const btn = document.getElementById('btnOutline');
            btn.disabled = true;
            btn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è...';

            try {
                const settings = Storage.load('settings');
                const prompt = `–°—Ç–≤–æ—Ä–∏ –¥–µ—Ç–∞–ª—å–Ω–∏–π outline –∫–Ω–∏–≥–∏ —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON:
–ù–∞–∑–≤–∞: ${settings.title}
–ñ–∞–Ω—Ä: ${settings.genre}
–°—Ç–∏–ª—å: ${settings.style}
–ü–µ—Ä—Å–æ–Ω–∞–∂—ñ: ${settings.characters}
–°–≤—ñ—Ç: ${settings.world}
–ì–æ–ª–æ–≤–Ω–∞ —ñ–¥–µ—è: ${settings.mainIdea}
–ö–æ–Ω—Ñ–ª—ñ–∫—Ç: ${settings.conflict}
–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ä–æ–∑–¥—ñ–ª—ñ–≤: ${settings.chapters}

–ü–æ–≤–µ—Ä–Ω–∏ –¢–Ü–õ–¨–ö–ò JSON –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω—å:
{
  "chapters": [
    {"number": 1, "title": "–ù–∞–∑–≤–∞", "summary": "–û–ø–∏—Å", "keyEvents": ["–ø–æ–¥—ñ—è1", "–ø–æ–¥—ñ—è2"]}
  ]
}`;

                const result = await callAPI(prompt);
                const jsonMatch = result.match(/\{[\s\S]*\}/);
                outline = JSON.parse(jsonMatch[0]);
                
                Storage.save('currentBook', { outline, chapters });
                displayOutline();
            } catch (error) {
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message);
            }

            btn.disabled = false;
            btn.textContent = '‚ñ∂Ô∏è –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ outline';
        }

        function displayOutline() {
            const container = document.getElementById('outlineContent');
            container.innerHTML = outline.chapters.map(ch => `
                <div class="bg-slate-700 p-4 rounded">
                    <h3 class="font-bold text-lg mb-2">–†–æ–∑–¥—ñ–ª ${ch.number}: ${ch.title}</h3>
                    <p class="text-sm text-slate-300 mb-2">${ch.summary}</p>
                    <div class="text-xs text-amber-400">–ü–æ–¥—ñ—ó: ${ch.keyEvents?.join(', ') || '–Ω–µ–º–∞—î'}</div>
                </div>
            `).join('');
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è —Ä–æ–∑–¥—ñ–ª—É
        async function generateChapter(chapterInfo, btnId) {
            const btn = document.getElementById(btnId);
            btn.disabled = true;
            btn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è...';

            try {
                const settings = Storage.load('settings');
                const prompt = `–ù–∞–ø–∏—à–∏ –ø–æ–≤–Ω–∏–π —Ç–µ–∫—Å—Ç —Ä–æ–∑–¥—ñ–ª—É ${chapterInfo.number}: "${chapterInfo.title}"

–ö–æ–Ω—Ç–µ–∫—Å—Ç: ${JSON.stringify(context)}
–ü–ª–∞–Ω: ${chapterInfo.summary}
–ü–æ–¥—ñ—ó: ${chapterInfo.keyEvents?.join(', ')}

–°—Ç–∏–ª—å: ${settings.style}
–ü–æ–µ—Ç–∏—á–Ω—ñ—Å—Ç—å: ${settings.poetryLevel}/10
–î–æ–≤–∂–∏–Ω–∞: ~2000 —Å–ª—ñ–≤

–ù–∞–ø–∏—à–∏ –¢–Ü–õ–¨–ö–ò —Ç–µ–∫—Å—Ç —Ä–æ–∑–¥—ñ–ª—É –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫—ñ–≤:`;

                const content = await callAPI(prompt);
                chapters.push({ ...chapterInfo, content });
                
                context.lastChapter = chapterInfo.number;
                context.events = [...(context.events || []), ...(chapterInfo.keyEvents || [])];
                
                Storage.save('currentBook', { outline, chapters });
                btn.textContent = '‚úÖ –ì–æ—Ç–æ–≤–æ';
                updateExportStatus();
            } catch (error) {
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞: ' + error.message);
                btn.disabled = false;
                btn.textContent = '–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏';
            }
        }

        // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ä–æ–∑–¥—ñ–ª—ñ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó
        switchTab = (function(original) {
            return function(tab) {
                original(tab);
                if (tab === 'generate') {
                    const container = document.getElementById('generateContent');
                    if (!outline) {
                        container.innerHTML = '<p class="text-slate-400">–°–ø–æ—á–∞—Ç–∫—É —Å—Ç–≤–æ—Ä—ñ—Ç—å outline</p>';
                        return;
                    }
                    
                    container.innerHTML = outline.chapters.map((ch, i) => {
                        const generated = chapters.find(c => c.number === ch.number);
                        return `
                            <div class="bg-slate-700 p-4 rounded mb-4">
                                <div class="flex justify-between items-center">
                                    <h3 class="font-bold">–†–æ–∑–¥—ñ–ª ${ch.number}: ${ch.title}</h3>
                                    ${!generated 
                                        ? `<button onclick="generateChapter(${JSON.stringify(ch).replace(/"/g, '&quot;')}, 'btn-ch-${i}')" id="btn-ch-${i}" class="bg-amber-500 hover:bg-amber-600 text-black px-4 py-2 rounded text-sm">–ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏</button>`
                                        : '<span class="text-green-400">‚úÖ –ì–æ—Ç–æ–≤–æ</span>'
                                    }
                                </div>
                                ${generated ? `<div class="mt-2 text-sm text-slate-300 max-h-40 overflow-y-auto">${generated.content.substring(0, 500)}...</div>` : ''}
                            </div>
                        `;
                    }).join('');
                }
                
                if (tab === 'export') {
                    updateExportStatus();
                    updatePreview();
                }
            };
        })(switchTab);

        function updateExportStatus() {
            document.getElementById('exportStatus').textContent = `${chapters.length} / ${outline?.chapters?.length || 0}`;
        }

        function updatePreview() {
            const container = document.getElementById('previewContent');
            if (chapters.length === 0) {
                container.innerHTML = '<p class="text-slate-400">–ù–µ–º–∞—î –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏—Ö —Ä–æ–∑–¥—ñ–ª—ñ–≤</p>';
                return;
            }
            
            container.innerHTML = chapters.map(ch => `
                <div class="mb-6">
                    <h4 class="text-lg font-bold text-amber-400 mb-2">–†–æ–∑–¥—ñ–ª ${ch.number}: ${ch.title}</h4>
                    <p class="whitespace-pre-wrap text-slate-300">${ch.content}</p>
                </div>
            `).join('');
        }

        // –ï–∫—Å–ø–æ—Ä—Ç
        function exportBook(format) {
            if (chapters.length === 0) {
                alert('‚ö†Ô∏è –ù–µ–º–∞—î —Ä–æ–∑–¥—ñ–ª—ñ–≤ –¥–ª—è –µ–∫—Å–ø–æ—Ä—Ç—É!');
                return;
            }

            const settings = Storage.load('settings');
            const title = settings.title || '–ö–Ω–∏–≥–∞';

            if (format === 'txt') {
                let content = `${title}\n${'='.repeat(title.length)}\n\n`;
                chapters.forEach(ch => {
                    content += `\n\n–†–û–ó–î–Ü–õ ${ch.number}: ${ch.title}\n${'-'.repeat(50)}\n\n${ch.content}\n`;
                });
                download(content, `${title}.txt`, 'text/plain');
            } else if (format === 'html') {
                let html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${title}</title>
<style>body{max-width:800px;margin:40px auto;font-family:Georgia,serif;line-height:1.8;padding:20px}
h1{text-align:center;border-bottom:2px solid #333}h2{margin-top:60px}</style>
</head><body><h1>${title}</h1>`;
                chapters.forEach(ch => {
                    html += `<h2>–†–æ–∑–¥—ñ–ª ${ch.number}: ${ch.title}</h2><div>${ch.content.replace(/\n/g, '<br>')}</div>`;
                });
                html += '</body></html>';
                download(html, `${title}.html`, 'text/html');
            } else if (format === 'epub') {
                let html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>${title}</title></head><body><h1>${title}</h1>`;
                chapters.forEach(ch => {
                    html += `<h2>–†–æ–∑–¥—ñ–ª ${ch.number}: ${ch.title}</h2><p>${ch.content.replace(/\n/g, '<br>')}</p>`;
                });
                html += '</body></html>';
                download(html, `${title}.epub`, 'application/epub+zip');
            }
        }

        function download(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
